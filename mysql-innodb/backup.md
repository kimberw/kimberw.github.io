# 备份与恢复

## 备份与恢复

按备份方法划分：

- 热备
- 冷备
- 温备

按备份内容划分：

- 逻辑备份
- 裸文件备份

按内容划分：

- 完全备份
- 增量备份
- 日志备份

## 冷备

冷备的优点：

- 备份简单，只要复制相关文件
- 备份文件易于在不同操作系统，不同mysql版本上进行恢复
- 恢复相当简单，只需要将文件恢复到指定位置即可
- 恢复速度快，不需要执行任何sql语句，页不需要重建索引

冷备的缺点：

- InnoDB存储引擎冷备文件比逻辑文件大很多
- 冷备的可扩展有时也对 操作系统，mysql版本，文件大小写，浮点数格式有要求。

## 逻辑备份

mysqldump

select ... into outfile

Load data infile

mysqlimport

## 热备

ibbackup

xtrabackup

## 快照备份

Mysql 本身不支持快照功能，快照备份是指通过文件系统支持的快照功能对数据库进行备份。

LVM是linux系统下对磁盘分区进行管理的一种机制。

## 复制

### 原理

复制是mysql数据库提供的一种高可用高新能的解决方案，一般用来建立大型的应用。工作原理分为3步：

1. 主服务器 master 把数据更改记录到二进制日志 binlog 中
2. 从服务器 slave 把主服务器的二进制日志复制到自己的中继日志 relay log 中。
3. 从服务器重做中继日志中的日志，把更改引用到自己的数据库上，以达到数据的最终一致性。

复制的实现是异步实时的，而非完全的主从同步，所以主从数据之间会有延迟。

### 快照+复制的备份架构

复制主要用来做备份，同时还有：

- 数据分布。不同数据中心之间实现数据复制
- 读取的负载均衡，可以通过多个从服务器，将读取平均分布到从服务器上，来减轻主服务器的压力。
- 数据库备份。从服务器不是备份，不能完全代替备份
- 高可用性和故障转移。减少故障导致的停机和恢复时间

若主服务器质性某个误操作，那么从服务器也跟着运行了，从服务器要如何恢复呢？从服务器上数据库所在分区做快照，来避免误操作对复制造成的印象。当发生主服务器误操作时，只需要将从服务器上的快照恢复，然后再根据二进制日志进行 point-in-time 的恢复即可。

建议从服务器上启动 read-only。保证从服务器上的数据仅与主服务器进行同步，避免其他线程修改数据。